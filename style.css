/* ============ Sn4ik-Store — основной скрипт ============ */

// --- Настройки
const ADMIN_PASSWORD = "Alex2307";
const TELEGRAM_TOKEN = "8060002374:AAGZ1B6fQutNTMMS22wOkgCH_defGVS8KVE";
const TELEGRAM_CHAT_ID = "6509764945";

// --- Состояния
let admin = false;
let cart = [];
let currentPage = 1;
const perPage = 6;
let sortMode = "default";
let query = "";

// --- Данные (по умолчанию)
let products = [
  {
    "name": "iPhone 16 Pro Max",
    "price": 199990,
    "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp",
    "specs": ["Чип A18 Pro", "Дисплей 6.9″ 120 Гц", "Титан", "Камера 48 МП", "Батарея 5000 мАч"],
    "memory": [
      { "size": "256 ГБ", "price": 199990 },
      { "size": "512 ГБ", "price": 229990 },
      { "size": "1 ТБ", "price": 259990 }
    ],
    "colors": [
      { "name": "Синий титан", "color": "#2a437a", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" },
      { "name": "Натуральный титан", "color": "#b6b1a9", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" },
      { "name": "Белый титан", "color": "#f4f4f4", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" }
    ]
  },
  {
    "name": "iPhone 16 Pro",
    "price": 154990,
    "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp",
    "specs": ["Чип A18 Pro", "Дисплей 6.3″ 120 Гц", "Титан", "Камера 48 МП", "Батарея 4500 мАч"],
    "memory": [
      { "size": "128 ГБ", "price": 154990 },
      { "size": "256 ГБ", "price": 169990 },
      { "size": "512 ГБ", "price": 199990 }
    ],
    "colors": [
      { "name": "Синий титан", "color": "#2a437a", "img": "hhttps://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" },
      { "name": "Чёрный титан", "color": "#222", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" }
    ]
  },
  {
    "name": "iPhone 16 Plus",
    "price": 119990,
    "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp",
    "specs": ["Чип A18", "Дисплей 6.7″ 90 Гц", "Алюминий", "Камера 48 МП", "Батарея 4800 мАч"],
    "memory": [
      { "size": "128 ГБ", "price": 119990 },
      { "size": "256 ГБ", "price": 134990 }
    ],
    "colors": [
      { "name": "Синий", "color": "#1e3a8a", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" },
      { "name": "Розовый", "color": "#f472b6", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" },
      { "name": "Зелёный", "color": "#15803d", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" }
    ]
  },
  {
    "name": "iPhone 16",
    "price": 99990,
    "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp",
    "specs": ["Чип A18", "Дисплей 6.1″ 60 Гц", "Алюминий", "Камера 48 МП", "Батарея 4000 мАч"],
    "memory": [
      { "size": "128 ГБ", "price": 99990 },
      { "size": "256 ГБ", "price": 114990 }
    ],
    "colors": [
      { "name": "Чёрный", "color": "#000", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" },
      { "name": "Белый", "color": "#f8fafc", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" },
      { "name": "Красный", "color": "#dc2626", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" }
    ]
  },
  {
    "name": "iPhone 15 Pro Max",
    "price": 149990,
    "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp",
    "specs": ["Чип A17 Pro", "Дисплей 6.7″ 120 Гц", "Титан", "Камера 48 МП", "Батарея 4400 мАч"],
    "memory": [
      { "size": "256 ГБ", "price": 149990 },
      { "size": "512 ГБ", "price": 174990 }
    ],
    "colors": [
      { "name": "Титан", "color": "#8b8b8b", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" },
      { "name": "Синий титан", "color": "#1e40af", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" }
    ]
  },
  {
    "name": "iPhone 15 Pro",
    "price": 124990,
    "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp",
    "specs": ["Чип A17 Pro", "Дисплей 6.1″ 120 Гц", "Титан", "Камера 48 МП", "Батарея 3800 мАч"],
    "memory": [
      { "size": "128 ГБ", "price": 124990 },
      { "size": "256 ГБ", "price": 139990 }
    ],
    "colors": [
      { "name": "Титан", "color": "#8b8b8b", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" },
      { "name": "Белый титан", "color": "#e5e5e5", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" }
    ]
  },
  {
    "name": "iPhone 15 Plus",
    "price": 104990,
    "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp",
    "specs": ["Чип A16", "Дисплей 6.7″ 60 Гц", "Алюминий", "Камера 48 МП", "Батарея 4300 мАч"],
    "memory": [
      { "size": "128 ГБ", "price": 104990 },
      { "size": "256 ГБ", "price": 119990 }
    ],
    "colors": [
      { "name": "Чёрный", "color": "#000", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" },
      { "name": "Синий", "color": "#3b82f6", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" }
    ]
  },
  {
    "name": "iPhone 15",
    "price": 89990,
    "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp",
    "specs": ["Чип A16", "Дисплей 6.1″ 60 Гц", "Алюминий", "Камера 48 МП", "Батарея 3500 мАч"],
    "memory": [
      { "size": "128 ГБ", "price": 89990 },
      { "size": "256 ГБ", "price": 104990 }
    ],
    "colors": [
      { "name": "Розовый", "color": "#f9a8d4", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" },
      { "name": "Зелёный", "color": "#4ade80", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" }
    ]
  },
  {
    "name": "iPhone 14 Pro Max",
    "price": 119990,
    "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp",
    "specs": ["Чип A16", "Дисплей 6.7″ 120 Гц", "Нержавейка", "Камера 48 МП", "Dynamic Island"],
    "memory": [
      { "size": "128 ГБ", "price": 119990 },
      { "size": "256 ГБ", "price": 134990 }
    ],
    "colors": [
      { "name": "Фиолетовый", "color": "#7e22ce", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" },
      { "name": "Золотой", "color": "#fef3c7", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" }
    ]
  },
  {
    "name": "iPhone 14 Pro",
    "price": 104990,
    "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp",
    "specs": ["Чип A16", "Дисплей 6.1″ 120 Гц", "Нержавейка", "Камера 48 МП", "Dynamic Island"],
    "memory": [
      { "size": "128 ГБ", "price": 104990 },
      { "size": "256 ГБ", "price": 119990 }
    ],
    "colors": [
      { "name": "Фиолетовый", "color": "#7e22ce", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" },
      { "name": "Серебристый", "color": "#d1d5db", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" }
    ]
  },
  {
    "name": "iPhone 14 Plus",
    "price": 89990,
    "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp",
    "specs": ["Чип A15", "Дисплей 6.7″ 60 Гц", "Алюминий", "Камера 12 МП", "Батарея 4300 мАч"],
    "memory": [
      { "size": "128 ГБ", "price": 89990 },
      { "size": "256 ГБ", "price": 104990 }
    ],
    "colors": [
      { "name": "Синий", "color": "#1d4ed8", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" },
      { "name": "Красный", "color": "#b91c1c", "img": "https://e-catalog.md/storage/ultra_images/66f2e54b3fe70.webp" }
    ]
  },
  
];

// --- Утилиты
const fmt = n => n.toLocaleString("ru-RU");
function $(id) { return document.getElementById(id); }

// --- Отображение товаров
function getFiltered() {
  let list = products.slice();
  if (query) list = list.filter(p => p.name.toLowerCase().includes(query));
  if (sortMode === "priceAsc") list.sort((a, b) => a.price - b.price);
  if (sortMode === "priceDesc") list.sort((a, b) => b.price - a.price);
  if (sortMode === "name") list.sort((a, b) => a.name.localeCompare(b.name, "ru"));
  return list;
}

function render() {
  const list = $("productList");
  list.innerHTML = "";
  const items = getFiltered();
  const totalPages = Math.max(1, Math.ceil(items.length / perPage));
  if (currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage - 1) * perPage;
  const pageItems = items.slice(start, start + perPage);

  pageItems.forEach(p => {
    const idx = products.indexOf(p);
    const card = document.createElement("div");
    card.className = "card";
    
    card.innerHTML = `
      <img src="${p.img}" alt="${p.name}" onclick="showProductModal(${idx})">
      <h3>${p.name}</h3>
      <p class="price">${fmt(p.price)} ₽</p>
      <button class="btn btn-primary" onclick="addToCart(${idx})">Добавить</button>
    `;

    list.appendChild(card);
  });

  renderPagination(totalPages);
}

function renderPagination(total) {
  const box = $("pagination");
  box.innerHTML = "";
  for (let i = 1; i <= total; i++) {
    const b = document.createElement("button");
    b.className = "page-btn" + (i === currentPage ? " active" : "");
    b.textContent = i;
    b.onclick = () => { currentPage = i; render(); };
    box.appendChild(b);
  }
}

// --- Поиск
function filterProducts() {
  query = $("searchInput").value.trim().toLowerCase();
  currentPage = 1;
  render();
}

// --- Сортировка
(function initSort() {
  const dd = $("sortDropdown");
  const btn = $("sortBtn");
  const menu = $("sortMenu");
  btn.addEventListener("click", e => {
    e.stopPropagation();
    dd.classList.toggle("open");
  });
  menu.querySelectorAll("button").forEach(b => {
    b.addEventListener("click", () => {
      sortMode = b.dataset.sort;
      btn.textContent =
        sortMode === "priceAsc" ? "Цена ↑" :
        sortMode === "priceDesc" ? "Цена ↓" :
        sortMode === "name" ? "По названию" : "Сортировка ▾";
      dd.classList.remove("open");
      render();
    });
  });
  document.addEventListener("click", () => dd.classList.remove("open"));
})();

// --- Корзина
function toggleCart() {
  const o = $("cartOverlay");
  o.style.display = o.style.display === "flex" ? "none" : "flex";
  renderCart();
}

function addToCart(i) {
  const product = products[i];
  cart.push(product);
  $("cartCount").textContent = cart.length;
  renderCart();
}

function renderCart() {
  const ul = $("cartItems");
  ul.innerHTML = "";
  let total = 0;
  cart.forEach((p, index) => {
    total += p.price;
    const li = document.createElement("li");
    li.innerHTML = `
      ${p.displayName || p.name} — ${fmt(p.price)} ₽
      <button onclick="removeFromCart(${index})" style="margin-left: 10px; background: var(--danger); border: none; color: white; border-radius: 4px; padding: 2px 6px;">✕</button>
    `;
    ul.appendChild(li);
  });
  $("totalPrice").textContent = fmt(total);
}

function removeFromCart(index) {
  cart.splice(index, 1);
  $("cartCount").textContent = cart.length;
  renderCart();
}

function clearCart() {
  cart = [];
  $("cartCount").textContent = 0;
  renderCart();
}

// --- Модалка товара с цветом и памятью
function showProductModal(i) {
  const product = products[i];
  $("productModal").style.display = "flex";
  
  // Очистка перед заполнением
  $("colorOptions").innerHTML = "";
  $("memorySelect").innerHTML = "";
  
  // Заполняем основную информацию
  $("modalTitle").textContent = product.name;
  $("modalImg").src = product.img;
  $("modalSpecs").innerHTML = product.specs.map(s => `<li>• ${s}</li>`).join("");
  
  // --- ВАРИАНТЫ ЦВЕТА ---
  const colorOptions = $("colorOptions");
  if (product.colors && product.colors.length > 0) {
    product.colors.forEach((colorObj, index) => {
      const colorSwatch = document.createElement("div");
      colorSwatch.className = "color-swatch" + (index === 0 ? " active" : "");
      colorSwatch.style.backgroundColor = colorObj.color;
      colorSwatch.title = colorObj.name;
      colorSwatch.onclick = () => {
        document.querySelectorAll(".color-swatch").forEach(sw => sw.classList.remove("active"));
        colorSwatch.classList.add("active");
        if (colorObj.img) {
          $("modalImg").src = colorObj.img;
        }
      };
      colorOptions.appendChild(colorSwatch);
    });
  } else {
    colorOptions.innerHTML = '<div style="color: var(--muted);">Нет вариантов цвета</div>';
  }
  
  // --- ВАРИАНТЫ ПАМЯТИ ---
  const memoryBox = $("memorySelect");
  if (product.memory && product.memory.length > 0) {
    const memoryList = document.createElement("div");
    memoryList.className = "custom-select";

    const selected = document.createElement("div");
    selected.className = "select-selected";
    selected.textContent = `${product.memory[0].size} — ${fmt(product.memory[0].price)} ₽`;

    const items = document.createElement("div");
    items.className = "select-items select-hide";

    product.memory.forEach((mem, index) => {
      const item = document.createElement("div");
      item.textContent = `${mem.size} — ${fmt(mem.price)} ₽`;
      item.onclick = () => {
        selected.textContent = item.textContent;
        $("modalPrice").textContent = `${fmt(mem.price)} ₽`;
        items.classList.add("select-hide");
        selected.classList.remove("active");
        memoryBox.dataset.selectedPrice = mem.price;
        memoryBox.dataset.selectedSize = mem.size;
      };
      items.appendChild(item);
    });

    memoryList.appendChild(selected);
    memoryList.appendChild(items);
    memoryBox.appendChild(memoryList);

    memoryBox.dataset.selectedPrice = product.memory[0].price;
    memoryBox.dataset.selectedSize = product.memory[0].size;
    $("modalPrice").textContent = `${fmt(product.memory[0].price)} ₽`;

    selected.onclick = (e) => {
      e.stopPropagation();
      items.classList.toggle("select-hide");
      selected.classList.toggle("active");
    };

    document.addEventListener("click", () => {
      items.classList.add("select-hide");
      selected.classList.remove("active");
    });

  } else {
    memoryBox.innerHTML = `<div style="color: var(--muted);">${fmt(product.price)} ₽</div>`;
    memoryBox.dataset.selectedPrice = product.price;
    memoryBox.dataset.selectedSize = "Базовый";
    $("modalPrice").textContent = `${fmt(product.price)} ₽`;
  }

  // --- КНОПКА ДОБАВЛЕНИЯ В КОРЗИНУ ---
  $("modalAddToCart").onclick = () => {
    const selectedPrice = +memoryBox.dataset.selectedPrice;
    const selectedSize = memoryBox.dataset.selectedSize;
    const selectedColor = document.querySelector(".color-swatch.active")?.title || "Стандартный";
    
    const cartProduct = {
      ...product,
      price: selectedPrice,
      selectedSize: selectedSize,
      selectedColor: selectedColor,
      displayName: `${product.name} (${selectedColor}, ${selectedSize})`
    };
    
    cart.push(cartProduct);
    $("cartCount").textContent = cart.length;
    renderCart();
    closeModal();
    
    $("cartBtn").classList.add("cart-pulse");
    setTimeout(() => $("cartBtn").classList.remove("cart-pulse"), 400);
  };
}

function closeModal() {
  $("productModal").style.display = "none";
}

// --- Оформление заказа
function placeOrder() {
  if (!cart.length) return alert("Корзина пуста 😅");
  $("orderOverlay").style.display = "flex";
}

function closeOrder() {
  $("orderOverlay").style.display = "none";
}

function sendOrder() {
  const name = $("orderName").value.trim();
  const phone = $("orderPhone").value.trim();
  const comment = $("orderComment").value.trim();
  if (!name || !phone) return alert("Введите имя и номер телефона!");

  const summary = cart.map(p => `• ${p.displayName || p.name} — ${fmt(p.price)} ₽`).join("\n");
  const total = fmt(cart.reduce((s, p) => s + p.price, 0));
  const message = `🛍 Новый заказ в Sn4ik-Store\n\n👤 Имя: ${name}\n📞 Телефон: ${phone}\n💬 Комментарий: ${comment || "—"}\n\n${summary}\n\n💰 Итого: ${total} ₽`;

  fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text: message })
  })
    .then(r => r.json())
    .then(d => {
      if (d.ok) {
        closeOrder();
        clearCart();
        toggleCart();
        alert("✅ Заказ успешно оформлен!");
      } else alert("⚠️ Ошибка отправки в Telegram.");
    })
    .catch(() => alert("⚠️ Ошибка соединения с Telegram"));
}

// --- Админ (только для экспорта)
function adminLogin() {
  const pass = prompt("Введите пароль администратора:");
  if (pass === ADMIN_PASSWORD) {
    admin = true;
    alert("✅ Админ-режим активен (только экспорт)");
    $("exportBtn").style.display = "inline-block";
    $("logoutBtn").style.display = "inline-block";
    $("adminLoginBtn").style.display = "none";
  } else alert("❌ Неверный пароль");
}

function logoutAdmin() {
  admin = false;
  alert("🚪 Вы вышли из админ-режима");
  $("logoutBtn").style.display = "none";
  $("exportBtn").style.display = "none";
  $("adminLoginBtn").style.display = "inline-block";
}

// --- Alt + A (вход в админку)
document.addEventListener("keydown", e => {
  if (e.altKey && e.code === "KeyA") {
    const b = $("adminLoginBtn");
    if (getComputedStyle(b).display === "none") {
      b.style.display = "inline-block";
      setTimeout(() => b.classList.add("show"), 10);
    } else {
      b.classList.remove("show");
      setTimeout(() => (b.style.display = "none"), 300);
    }
  }
});

// --- Оверлеи
function overlayClick(ev) {
  if (ev.target.classList.contains("overlay")) ev.target.style.display = "none";
}

// --- Экспорт
function exportProducts() {
  if (!admin) return alert("Только админ может экспортировать товары!");
  const dataStr = JSON.stringify(products, null, 2);
  const blob = new Blob([dataStr], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "products.json";
  a.click();
  URL.revokeObjectURL(url);
  alert("✅ Файл products.json сохранён!");
}

// --- Запуск
render();
